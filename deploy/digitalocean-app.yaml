name: carlosjportfolio
region: nyc
services:
  - name: backend
    github:
      repo: carlosj1999/DevPortfolio.git
      branch: main
      deploy_on_push: true
    dockerfile_path: backend/Dockerfile
    source_dir: .
    http_port: 8000
    instance_size_slug: basic-xxs
    instance_count: 1
    envs:
      - key: DJANGO_DEBUG
        scope: RUN_AND_BUILD_TIME
        value: "False"
      - key: DJANGO_ALLOWED_HOSTS
        scope: RUN_AND_BUILD_TIME
        value: carlosjportfolio.com,www.carlosjportfolio.com
      - key: DJANGO_CSRF_TRUSTED_ORIGINS
        scope: RUN_AND_BUILD_TIME
        value: https://carlosjportfolio.com,https://www.carlosjportfolio.com
      - key: DJANGO_SECRET_KEY
        scope: RUN_AND_BUILD_TIME
        value: ${DJANGO_SECRET_KEY}
      - key: CORS_ALLOWED_ORIGINS
        scope: RUN_AND_BUILD_TIME
        value: https://carlosjportfolio.com
      - key: OPENAI_API_KEY
        scope: RUN_AND_BUILD_TIME
        value: ${OPENAI_API_KEY}
      - key: DATABASE_URL
        scope: RUN_AND_BUILD_TIME
        value: ${db.DATABASE_URL}
      - key: VITE_BACKEND_ORIGIN
        scope: RUN_AND_BUILD_TIME
        value: https://carlosjportfolio.com
      - key: DJANGO_SECURE_SSL_REDIRECT
        scope: RUN_AND_BUILD_TIME
        value: "True"
    run_command: >
      sh -c "python manage.py collectstatic --noinput && \
      gunicorn backend_config.wsgi:application --bind 0.0.0.0:8000 --workers 4 --threads 2 --worker-class gthread --worker-tmp-dir /dev/shm --access-logfile - --error-logfile -"
    health_check:
      http_path: /health/
      initial_delay_seconds: 10
      period_seconds: 30
    routes:
      - path: /
        preserve_path_prefix: false
        protocol: https

postdeploy:
  - name: migrate-db
    cmd: python manage.py migrate
    service: backend

alerts:
  - rule: cpu
    operator: GREATER_THAN
    value: 80
    window: FIVE_MINUTES
    recipients:
      - type: email
        target: you@example.com

domains:
  - domain: carlosjportfolio.com
    type: PRIMARY
    wildcard: false
    service: backend
    port: 8000